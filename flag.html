<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>US State Data Breach Rules</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #0f172a;
      --card-bg: #111827;
      --accent: #2563eb;
      --accent-soft: rgba(37, 99, 235, 0.15);
      --border-subtle: #1f2937;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --chip-bg: #1f2937;
      --danger: #f97373;
      --radius-lg: 16px;
      --radius-md: 10px;
      --shadow-soft: 0 18px 40px rgba(0, 0, 0, 0.45);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #1d2638 0, #020617 50%);
      color: var(--text-main);
      min-height: 100vh;
      padding: 24px;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    .app-shell {
      width: 100%;
      max-width: 1280px;
      background: rgba(15, 23, 42, 0.96);
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      box-shadow: var(--shadow-soft);
      padding: 20px 24px 24px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    /* Header / Flag */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .flag {
      width: 96px;
      height: 60px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: 0 8px 22px rgba(0, 0, 0, 0.45);
      background: #b91c1c;
      position: relative;
    }

    .flag-stripe {
      position: absolute;
      left: 0;
      right: 0;
      height: 5px;
      background: #f9fafb;
    }

    .flag-stripe:nth-child(1) { top: 0; }
    .flag-stripe:nth-child(2) { top: 10px; }
    .flag-stripe:nth-child(3) { top: 20px; }
    .flag-stripe:nth-child(4) { top: 30px; }
    .flag-stripe:nth-child(5) { top: 40px; }
    .flag-stripe:nth-child(6) { top: 50px; }

    .flag-canton {
      position: absolute;
      top: 0;
      left: 0;
      width: 40px;
      height: 32px;
      background: #1d4ed8;
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      grid-template-rows: repeat(4, 1fr);
      padding: 3px;
      gap: 1px;
    }

    .flag-star {
      width: 3px;
      height: 3px;
      border-radius: 999px;
      background: #f9fafb;
      opacity: 0.85;
    }

    .header-text h1 {
      font-size: 1.4rem;
      font-weight: 600;
      letter-spacing: 0.02em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .header-text h1 span.badge {
      font-size: 0.7rem;
      font-weight: 500;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.85);
      color: var(--text-muted);
    }

    .header-text p {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .chip {
      padding: 6px 10px;
      border-radius: 999px;
      background: var(--chip-bg);
      border: 1px solid var(--border-subtle);
      font-size: 0.75rem;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .chip-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 0 5px var(--accent-soft);
    }

    /* Layout */
    .content {
      display: grid;
      grid-template-columns: minmax(0, 0.9fr) minmax(0, 1.4fr);
      gap: 20px;
      margin-top: 6px;
    }

    /* States panel */
    .states-panel {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .panel-header {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .panel-header h2 {
      font-size: 1rem;
      font-weight: 600;
    }

    .panel-header span {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .state-search {
      margin-top: 4px;
      position: relative;
    }

    .state-search input {
      width: 100%;
      padding: 8px 10px 8px 28px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: #020617;
      color: var(--text-main);
      font-size: 0.8rem;
      outline: none;
    }

    .state-search input::placeholder {
      color: #6b7280;
    }

    .state-search-icon {
      position: absolute;
      left: 9px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.75rem;
      color: #6b7280;
      pointer-events: none;
    }

    .states-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 8px;
      margin-top: 8px;
      max-height: 360px;
      overflow: auto;
      padding-right: 2px;
    }

    .state-pill {
      border-radius: var(--radius-md);
      border: 1px solid var(--border-subtle);
      padding: 7px 8px;
      font-size: 0.8rem;
      color: var(--text-muted);
      background: linear-gradient(145deg, #020617, #020617);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 2px;
      transition: border 0.18s ease, background 0.18s ease, transform 0.12s ease,
        box-shadow 0.18s ease;
    }

    .state-pill .state-name {
      font-weight: 500;
      color: var(--text-main);
      font-size: 0.8rem;
    }

    .state-pill .state-code {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .state-pill:hover {
      transform: translateY(-1px);
      border-color: var(--accent);
      background: radial-gradient(circle at top, rgba(37, 99, 235, 0.14), #020617);
      box-shadow: 0 10px 18px rgba(15, 23, 42, 0.55);
    }

    .state-pill.active {
      border-color: var(--accent);
      background: radial-gradient(circle at top left, var(--accent-soft), #020617);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.5);
    }

    /* Details panel */
    .details-panel {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
      padding: 16px 16px 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      position: relative;
      overflow: hidden;
    }

    .gradient-glow {
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: radial-gradient(circle at top right, rgba(37, 99, 235, 0.18), transparent 55%);
      opacity: 0.75;
      mix-blend-mode: screen;
    }

    .details-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      position: relative;
      z-index: 1;
    }

    .details-title-group {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .details-title {
      font-size: 1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .details-title span.code-badge {
      font-size: 0.7rem;
      font-weight: 500;
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      color: var(--text-muted);
      background: rgba(15, 23, 42, 0.85);
    }

    .details-subtitle {
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .details-chips {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .badge-pill {
      font-size: 0.68rem;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .badge-pill .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
    }

    .badge-pill.danger .badge-dot {
      background: var(--danger);
    }

    .badge-pill.danger {
      border-color: rgba(248, 113, 113, 0.5);
      color: #fecaca;
    }

    /* Filter bar inside details */
    .details-filters {
      position: relative;
      z-index: 1;
      margin-top: 4px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
    }

    .details-filters-left {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .field-select {
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: #020617;
      color: var(--text-main);
      font-size: 0.75rem;
      padding: 6px 10px;
      outline: none;
    }

    .details-search {
      position: relative;
    }

    .details-search input {
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: #020617;
      color: var(--text-main);
      font-size: 0.75rem;
      padding: 6px 10px 6px 24px;
      outline: none;
      min-width: 180px;
    }

    .details-search input::placeholder {
      color: #6b7280;
    }

    .details-search-icon {
      position: absolute;
      left: 7px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.75rem;
      color: #6b7280;
    }

    /* Row-style sections */
    .rules-sections-wrapper {
      position: relative;
      z-index: 1;
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.96);
      margin-top: 4px;
      max-height: 340px;
      overflow: auto;
    }

    .rules-sections {
      display: flex;
      flex-direction: column;
    }

    .rules-section {
      display: grid;
      grid-template-columns: 210px minmax(0, 1fr);
      gap: 12px;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
    }

    .rules-section:last-child {
      border-bottom: none;
    }

    .rules-section-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      align-self: flex-start;
    }

    .rules-section-label span {
      display: inline-block;
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: rgba(2, 6, 23, 0.9);
    }

    .rules-section-content {
      font-size: 0.78rem;
      color: var(--text-main);
      line-height: 1.45;
      white-space: pre-line;
    }

    .rules-section-content.muted {
      color: var(--text-muted);
    }

    .rules-section-content a {
      color: #bfdbfe;
      text-decoration: none;
      font-size: 0.78rem;
    }

    .rules-section-content a:hover {
      text-decoration: underline;
    }

    .rules-section-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 7px;
      border-radius: 999px;
      font-size: 0.7rem;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .rules-section-pill strong {
      color: var(--text-main);
      font-weight: 500;
    }

    .details-footer {
      font-size: 0.7rem;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      gap: 16px;
      margin-top: 2px;
      position: relative;
      z-index: 1;
    }

    .details-footer span {
      opacity: 0.9;
    }

    .hidden {
  display: none !important;
}

    .highlight-state {
      color: #e5e7eb;
      font-weight: 500;
    }

    @media (max-width: 960px) {
      body {
        padding: 12px;
      }

      .app-shell {
        padding: 16px 14px;
      }

      .content {
        grid-template-columns: 1fr;
      }

      .details-panel {
        order: -1;
      }

      .rules-section {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 600px) {
      .header {
        flex-direction: column;
        align-items: flex-start;
      }

      .header-right {
        width: 100%;
        justify-content: flex-start;
        flex-wrap: wrap;
      }

      .states-grid {
        max-height: 240px;
      }

      .details-footer {
        flex-direction: column;
      }

      .details-search input {
        min-width: 0;
        width: 150px;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="header">
      <div class="header-left">
        <div class="flag" aria-label="Flag of the United States">
          <div class="flag-stripe"></div>
          <div class="flag-stripe"></div>
          <div class="flag-stripe"></div>
          <div class="flag-stripe"></div>
          <div class="flag-stripe"></div>
          <div class="flag-stripe"></div>
          <div class="flag-canton">
            <div class="flag-star"></div><div class="flag-star"></div><div class="flag-star"></div><div class="flag-star"></div><div class="flag-star"></div><div class="flag-star"></div>
            <div class="flag-star"></div><div class="flag-star"></div><div class="flag-star"></div><div class="flag-star"></div><div class="flag-star"></div><div class="flag-star"></div>
            <div class="flag-star"></div><div class="flag-star"></div><div class="flag-star"></div><div class="flag-star"></div><div class="flag-star"></div><div class="flag-star"></div>
            <div class="flag-star"></div><div class="flag-star"></div><div class="flag-star"></div><div class="flag-star"></div><div class="flag-star"></div><div class="flag-star"></div>
          </div>
        </div>
        <div class="header-text">
          <h1>
            US State Data Breach Rules
            <span class="badge">Interactive reference</span>
          </h1>
          <p>Select a state to view personal information definitions, breach triggers, and notification timelines.</p>
        </div>
      </div>
      <div class="header-right">
        <div class="chip">
          <span class="chip-dot"></span>
          50 states + DC
        </div>
        <div class="chip">
          Breach notification ¬∑ PII ¬∑ AG thresholds
        </div>
      </div>
    </header>

    <main class="content">
      <!-- Left: States -->
      <section class="states-panel">
        <div class="panel-header">
          <h2>States</h2>
          <span>Tap a state to view its cybersecurity and breach notification rules.</span>
        </div>
        <div class="state-search">
          <span class="state-search-icon">üîç</span>
          <input
            id="stateSearch"
            type="text"
            placeholder="Filter by name or code (CA, Texas, NY)..."
          />
        </div>
        <div class="states-grid" id="statesGrid"></div>
      </section>

      <!-- Right: Details -->
      <section class="details-panel" aria-live="polite">
        <div class="gradient-glow"></div>

        <div class="details-header">
          <div class="details-title-group">
            <div class="details-title">
              <span id="detailsStateName">No state selected</span>
              <span id="detailsStateCode" class="code-badge">US</span>
            </div>
            <p class="details-subtitle" id="detailsSubtitle">
              Click a state on the left to load its statutes and breach notification requirements.
            </p>
          </div>
          <div class="details-chips">
            <span class="badge-pill">
              <span class="badge-dot"></span>
              PII + Breach
            </span>
            <span class="badge-pill danger">
              <span class="badge-dot"></span>
              Time sensitive
            </span>
          </div>
        </div>



        <div class="details-filters">
  <div class="details-filters-left">
    <div id="uploadModule">
  <label style="font-size: 0.7rem; color: #9ca3af;">
    Load rules from TSV:
    <input id="csvFileInput" type="file" accept=".tsv"
           style="font-size: 0.7rem; margin-left: 4px;" />
  </label>
</div>

    <select id="fieldFilter" class="field-select">
      <option value="all">Show all fields</option>
    </select>
  </div>
  <div class="details-search">
    <span class="details-search-icon">üîç</span>
    <input
      id="detailSearch"
      type="text"
      placeholder="Search within this state..."
    />
  </div>
</div>


        <div class="rules-sections-wrapper">
          <div class="rules-sections" id="rulesSections">
            <div class="rules-section">
              <div class="rules-section-label">
                <span>Instructions</span>
              </div>
              <div class="rules-section-content muted">
                Select a state on the left. Each field will appear here as a row:
                statute citation, PII definition, breach definition, risk of harm analysis,
                timing for notices, exemptions, and penalties. Use the dropdown above to
                focus on a single field or the search box to filter text.
              </div>
            </div>
          </div>
        </div>

        <div class="details-footer">
          <span>
            Tip: treat this as a worksheet. As you research each state, paste legal text
            into the corresponding fields in your Google Sheet.
          </span>
          <span>
            Status for <span class="highlight-state" id="footerStateName">United States (overview)</span> ¬∑ Source: internal sheet
          </span>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ---- Field metadata (used for labels, dropdown, and mapping) ----------------
    const FIELD_DEFS = [
      { key: "statute", label: "Statute(s) Citation" },
      { key: "pii", label: "Definition of Personal Information (PII)" },
      { key: "breach", label: "Definition of Breach" },
      { key: "riskOfHarm", label: "Risk of Harm Analysis" },
      { key: "timingIndividuals", label: "Timing: Notification to Individuals" },
      { key: "timingAG", label: "Timing: Notification to Attorney General (AG)" },
      { key: "timingCreditAgencies", label: "Timing: Notification to Credit Agencies" },
      { key: "noticeContent", label: "Contents of Notice (to Individuals)" },
      { key: "noticeMethod", label: "Method of Notice (to Individuals)" },
      { key: "penalties", label: "Penalties for Non-Compliance" },
      { key: "exemptions", label: "Key Exemptions" },
      { key: "sourceUrl", label: "Source URL" },
      { key: "notes", label: "Notes / Other Requirements" }
    ];

    // ---- Base state data (will be augmented by Google Sheet) -------------------
    const STATES = [
      {
        code: "AL",
        name: "Alabama",
        category: "Standard notification",
        rules: [
          {
            statute: "Example: Ala. Code ¬ß 8-38-1 et seq.",
            pii: "First name or initial and last name with SSN, driver license, financial account numbers with required access codes. You can paste the full statutory definition here.",
            breach: "Unauthorized acquisition of unencrypted data that materially compromises the security or confidentiality of personal information.",
            riskOfHarm: "Risk of harm analysis required to determine if misuse is reasonably likely before notice is triggered.",
            timingIndividuals: "Without unreasonable delay, typically within X days of determining that a breach occurred.",
            timingAG: "Required when more than X residents are affected or if special sectors apply.",
            timingCreditAgencies: "Notify consumer reporting agencies when more than X residents require notification.",
            noticeContent: "Must include description of the incident, types of information involved, contact information, and steps individuals can take.",
            noticeMethod: "Written notice, electronic notice consistent with E-SIGN, or substitute notice such as website posting and media if cost or scope thresholds are met.",
            penalties: "Civil penalties enforceable by the AG. Insert details once researched.",
            exemptions: "Encrypted data, good faith acquisition by an employee, and GLBA/HIPAA entities as provided by statute.",
            sourceUrl: "https://example.alabama.gov/breach-statute",
            notes: "Add any special sector rules, safe harbors, or data security program requirements here."
          }
        ]
      },
      {
        code: "AK", name: "Alaska", category: "To be researched", rules: []
      },
      {
        code: "AZ", name: "Arizona", category: "To be researched", rules: []
      },
      {
        code: "AR", name: "Arkansas", category: "To be researched", rules: []
      },
      {
        code: "CA",
        name: "California",
        category: "Strong consumer protections",
        rules: [
          {
            statute: "Cal. Civ. Code ¬ß¬ß 1798.29, 1798.82 (example placeholder)",
            pii: "First name or initial and last name combined with identifiers such as SSN, driver license, financial account information, medical information, health insurance information, and online account credentials.",
            breach: "Unauthorized acquisition of computerized data that compromises the security, confidentiality, or integrity of personal information.",
            riskOfHarm: "Risk of harm assessment is often implied in enforcement guidance. You can summarize AG guidance here.",
            timingIndividuals: "In the most expedient time possible and without unreasonable delay, subject to law enforcement needs.",
            timingAG: "AG notice required for breaches affecting more than a specified number of residents.",
            timingCreditAgencies: "Required if a certain volume of residents must be notified.",
            noticeContent: "Plain language notice including incident overview, categories of PII, dates, toll-free numbers, and information on credit monitoring if offered.",
            noticeMethod: "Written or electronic notice, with model format and headings that can be added in notes.",
            penalties: "Enforced under consumer protection statutes and data protection acts. Insert details on private right of action if applicable.",
            exemptions: "Entities compliant with HIPAA or GLBA may have limited exemptions when equivalent notice is given.",
            sourceUrl: "https://example.ca.gov/data-breach-law",
            notes: "You can also cross-reference CCPA / CPRA obligations here for broader security and incident response requirements."
          }
        ]
      },
      {
        code: "CO", name: "Colorado", category: "To be researched", rules: []
      },
      {
        code: "CT", name: "Connecticut", category: "To be researched", rules: []
      },
      {
        code: "DE", name: "Delaware", category: "To be researched", rules: []
      },
      {
        code: "FL", name: "Florida", category: "To be researched", rules: []
      },
      {
        code: "GA", name: "Georgia", category: "To be researched", rules: []
      },
      {
        code: "HI", name: "Hawaii", category: "To be researched", rules: []
      },
      {
        code: "ID", name: "Idaho", category: "To be researched", rules: []
      },
      {
        code: "IL", name: "Illinois", category: "To be researched", rules: []
      },
      {
        code: "IN", name: "Indiana", category: "To be researched", rules: []
      },
      {
        code: "IA", name: "Iowa", category: "To be researched", rules: []
      },
      {
        code: "KS", name: "Kansas", category: "To be researched", rules: []
      },
      {
        code: "KY", name: "Kentucky", category: "To be researched", rules: []
      },
      {
        code: "LA", name: "Louisiana", category: "To be researched", rules: []
      },
      {
        code: "ME", name: "Maine", category: "To be researched", rules: []
      },
      {
        code: "MD", name: "Maryland", category: "To be researched", rules: []
      },
      {
        code: "MA", name: "Massachusetts", category: "To be researched", rules: []
      },
      {
        code: "MI", name: "Michigan", category: "To be researched", rules: []
      },
      {
        code: "MN", name: "Minnesota", category: "To be researched", rules: []
      },
      {
        code: "MS", name: "Mississippi", category: "To be researched", rules: []
      },
      {
        code: "MO", name: "Missouri", category: "To be researched", rules: []
      },
      {
        code: "MT", name: "Montana", category: "To be researched", rules: []
      },
      {
        code: "NE", name: "Nebraska", category: "To be researched", rules: []
      },
      {
        code: "NV", name: "Nevada", category: "To be researched", rules: []
      },
      {
        code: "NH", name: "New Hampshire", category: "To be researched", rules: []
      },
      {
        code: "NJ", name: "New Jersey", category: "To be researched", rules: []
      },
      {
        code: "NM", name: "New Mexico", category: "To be researched", rules: []
      },
      {
        code: "NY", name: "New York", category: "To be researched", rules: []
      },
      {
        code: "NC", name: "North Carolina", category: "To be researched", rules: []
      },
      {
        code: "ND", name: "North Dakota", category: "To be researched", rules: []
      },
      {
        code: "OH", name: "Ohio", category: "To be researched", rules: []
      },
      {
        code: "OK", name: "Oklahoma", category: "To be researched", rules: []
      },
      {
        code: "OR", name: "Oregon", category: "To be researched", rules: []
      },
      {
        code: "PA", name: "Pennsylvania", category: "To be researched", rules: []
      },
      {
        code: "RI", name: "Rhode Island", category: "To be researched", rules: []
      },
      {
        code: "SC", name: "South Carolina", category: "To be researched", rules: []
      },
      {
        code: "SD", name: "South Dakota", category: "To be researched", rules: []
      },
      {
        code: "TN", name: "Tennessee", category: "To be researched", rules: []
      },
      {
        code: "TX",
        name: "Texas",
        category: "Strict timelines",
        rules: [
          {
            statute: "Example: Tex. Bus. & Com. Code ¬ß 521.053",
            pii: "First name or initial and last name with SSN, driver license, or financial account details. Include biometric or health data if statute includes it.",
            breach: "Unauthorized acquisition of computerized data that compromises security or confidentiality of PII.",
            riskOfHarm: "Risk of harm analysis permitted. Organizations may document why a breach is unlikely to result in harm.",
            timingIndividuals: "Not later than X days after determination of breach. Replace X with the statutory number when you research.",
            timingAG: "AG must be notified when X or more residents are affected, generally within the same timeframe as individual notice.",
            timingCreditAgencies: "Notice to consumer reporting agencies when a threshold number of residents is impacted.",
            noticeContent: "Description of incident, types of PII, contact information, and any remediation or credit monitoring details.",
            noticeMethod: "Written, electronic, or substitute notice as allowed by statute.",
            penalties: "Civil penalties per violation or per affected individual, up to a statutory cap.",
            exemptions: "Encrypted data, good faith acquisition, and certain regulated entities if they comply with federal sector rules.",
            sourceUrl: "https://example.texas.gov/breach-requirements",
            notes: "Use this area to track security program obligations or retention rules if relevant."
          }
        ]
      },
      {
        code: "UT", name: "Utah", category: "To be researched", rules: []
      },
      {
        code: "VT", name: "Vermont", category: "To be researched", rules: []
      },
      {
        code: "VA", name: "Virginia", category: "To be researched", rules: []
      },
      {
        code: "WA", name: "Washington", category: "To be researched", rules: []
      },
      {
        code: "WV", name: "West Virginia", category: "To be researched", rules: []
      },
      {
        code: "WI", name: "Wisconsin", category: "To be researched", rules: []
      },
      {
        code: "WY", name: "Wyoming", category: "To be researched", rules: []
      },
      {
        code: "DC", name: "District of Columbia", category: "To be researched", rules: []
      }
    ];

    // ---- DOM references --------------------------------------------------------
    const statesGridEl = document.getElementById("statesGrid");
    const stateSearchEl = document.getElementById("stateSearch");
    const rulesSectionsEl = document.getElementById("rulesSections");
    const detailsStateNameEl = document.getElementById("detailsStateName");
    const detailsStateCodeEl = document.getElementById("detailsStateCode");
    const detailsSubtitleEl = document.getElementById("detailsSubtitle");
    const footerStateNameEl = document.getElementById("footerStateName");
    const fieldFilterEl = document.getElementById("fieldFilter");
    const detailSearchEl = document.getElementById("detailSearch");

    let activeStateCode = null;
    let activeRuleIndex = 0; // if multiple rows per state later

    // ---- Populate field dropdown ----------------------------------------------
    FIELD_DEFS.forEach(field => {
      const opt = document.createElement("option");
      opt.value = field.key;
      opt.textContent = field.label;
      fieldFilterEl.appendChild(opt);
    });

    // ---- Render states list ----------------------------------------------------
    function renderStates(filterText = "") {
      const query = filterText.trim().toLowerCase();
      statesGridEl.innerHTML = "";

      STATES
        .slice()
        .sort((a, b) => a.name.localeCompare(b.name))
        .filter(state => {
          if (!query) return true;
          return (
            state.name.toLowerCase().includes(query) ||
            state.code.toLowerCase().includes(query)
          );
        })
        .forEach(state => {
          const btn = document.createElement("button");
          btn.className = "state-pill";
          if (state.code === activeStateCode) btn.classList.add("active");

          const nameSpan = document.createElement("span");
          nameSpan.className = "state-name";
          nameSpan.textContent = state.name;

          const codeSpan = document.createElement("span");
          codeSpan.className = "state-code";
          codeSpan.textContent = state.code;

          btn.appendChild(nameSpan);
          btn.appendChild(codeSpan);

          btn.addEventListener("click", () => setActiveState(state.code));

          statesGridEl.appendChild(btn);
        });
    }

    // ---- Set active state ------------------------------------------------------
    function setActiveState(code) {
      activeStateCode = code;
      activeRuleIndex = 0;
      renderStates(stateSearchEl.value);

        // hide upload once the user starts using the app
  if (uploadModule) {
    uploadModule.classList.add("hidden");
  }

      const state = STATES.find(s => s.code === code);
      if (!state) return;

      detailsStateNameEl.textContent = state.name;
      detailsStateCodeEl.textContent = state.code;
      footerStateNameEl.textContent = state.name;

      if (state.rules && state.rules.length > 0) {
        detailsSubtitleEl.textContent =
          "Summary of personal information definitions, breach triggers, and notification timelines for " +
          state.name +
          ".";
        renderRulesSections();
      } else {
        detailsSubtitleEl.textContent =
          "Template ready. Use this panel to enter statutes and breach notification requirements for " +
          state.name +
          ".";
        renderEmptyTemplateSections(state.name);
      }
    }

    // ---- Render row-style sections --------------------------------------------
    function renderRulesSections() {
      const state = STATES.find(s => s.code === activeStateCode);
      if (!state || !state.rules || state.rules.length === 0) {
        renderEmptyTemplateSections(state ? state.name : "this state");
        return;
      }

      const rule = state.rules[activeRuleIndex] || state.rules[0];
      const filterKey = fieldFilterEl.value;
      const searchQuery = detailSearchEl.value.trim().toLowerCase();

      rulesSectionsEl.innerHTML = "";

      FIELD_DEFS.forEach(field => {
        if (filterKey !== "all" && filterKey !== field.key) return;

        const value = (rule[field.key] || "").toString();
        const lowerValue = value.toLowerCase();

        if (searchQuery && !lowerValue.includes(searchQuery) && !field.label.toLowerCase().includes(searchQuery)) {
          return;
        }

        const section = document.createElement("div");
        section.className = "rules-section";

        const labelDiv = document.createElement("div");
        labelDiv.className = "rules-section-label";
        const labelChip = document.createElement("span");
        labelChip.textContent = field.label;
        labelDiv.appendChild(labelChip);

        const contentDiv = document.createElement("div");
        contentDiv.className = "rules-section-content";

        if (!value) {
          contentDiv.textContent = "No information entered yet. Add this field in your Google Sheet.";
          contentDiv.classList.add("muted");
        } else if (field.key === "statute") {
          const pill = document.createElement("span");
          pill.className = "rules-section-pill";
          pill.innerHTML = "<strong>Statute</strong> " + value;
          contentDiv.appendChild(pill);
        } else if (field.key === "sourceUrl") {
          const link = document.createElement("a");
          link.href = value;
          link.target = "_blank";
          link.rel = "noopener noreferrer";
          link.textContent = "Open statute / guidance";
          contentDiv.appendChild(link);
        } else {
          contentDiv.textContent = value;
        }

        section.appendChild(labelDiv);
        section.appendChild(contentDiv);
        rulesSectionsEl.appendChild(section);
      });

      if (!rulesSectionsEl.children.length) {
        const section = document.createElement("div");
        section.className = "rules-section";
        const labelDiv = document.createElement("div");
        labelDiv.className = "rules-section-label";
        const labelChip = document.createElement("span");
        labelChip.textContent = "No match";
        labelDiv.appendChild(labelChip);

        const contentDiv = document.createElement("div");
        contentDiv.className = "rules-section-content muted";
        contentDiv.textContent = "No fields match your current filter or search.";

        section.appendChild(labelDiv);
        section.appendChild(contentDiv);
        rulesSectionsEl.appendChild(section);
      }
    }

    function renderEmptyTemplateSections(stateName) {
      rulesSectionsEl.innerHTML = "";
      const section = document.createElement("div");
      section.className = "rules-section";

      const labelDiv = document.createElement("div");
      labelDiv.className = "rules-section-label";
      const labelChip = document.createElement("span");
      labelChip.textContent = "Template";
      labelDiv.appendChild(labelChip);

      const contentDiv = document.createElement("div");
      contentDiv.className = "rules-section-content muted";
      contentDiv.textContent =
        "No rules have been entered yet for " +
        stateName +
        ". Each row here corresponds to a column in your Google Sheet. " +
        "As you populate the sheet for this state, refresh the page to see the content appear.";

      section.appendChild(labelDiv);
      section.appendChild(contentDiv);
      rulesSectionsEl.appendChild(section);
    }

    // ---- Event listeners -------------------------------------------------------
    stateSearchEl.addEventListener("input", e => {
      renderStates(e.target.value);
    });

    fieldFilterEl.addEventListener("change", () => {
      if (!activeStateCode) return;
      renderRulesSections();
    });

    detailSearchEl.addEventListener("input", () => {
      if (!activeStateCode) return;
      renderRulesSections();
    });

    // ---- Google Sheets integration (CSV) ---------------------------------------
    // Easiest option (no auth): in Google Sheets:
    //   File -> Share -> Publish to web -> Entire sheet -> CSV
    //   Copy the generated URL and paste it below.
    //
    // Expected header row in your sheet:
    //   state_code, statute, pii, breach, riskOfHarm, timingIndividuals,
    //   timingAG, timingCreditAgencies, noticeContent, noticeMethod,
    //   penalties, exemptions, sourceUrl, notes
    //
    // Example:
    //   CA,"Cal. Civ. Code ...","PII text...","Breach text...", ... etc
    //
    const SHEET_CSV_URL = ""; // <---- put your published CSV URL here

    // We no longer need a URL ‚Äì user will upload a CSV file
// expected headers:
// Serial No., State / Jurisdiction, Statute(s) Citation,
// Definition of Personal Information (PII), Definition of Breach,
// Risk of Harm Analysis, ... (plus other columns if you have them)

// Helper: take raw CSV text and merge it into STATES[]
function applySheetTsvText(text) {
  const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
  if (lines.length <= 1) return;

  // NOTE: use "\t" instead of ","
  const header = lines[0].split("\t").map(h => h.trim());
  const lowerHeader = header.map(h => h.toLowerCase());

  const findCol = (...candidates) => {
    const targets = candidates.map(c => c.toLowerCase());
    return lowerHeader.findIndex(h => targets.some(t => h.includes(t)));
  };

  const idxStateName     = findCol("state / jurisdiction", "state");
  const idxStatute       = findCol("statute(s) citation");
  const idxPII           = findCol("definition of personal information");
  const idxBreach        = findCol("definition of breach");
  const idxRiskOfHarm    = findCol("risk of harm analysis");
  const idxTimingInd     = findCol("notification to individuals");
  const idxTimingAG      = findCol("notification to attorney general", "notification to ag");
  const idxTimingCredit  = findCol("notification to credit");
  const idxNoticeContent = findCol("contents of notice", "content of notice");
  const idxNoticeMethod  = findCol("method of notice");
  const idxPenalties     = findCol("penalties");
  const idxExemptions    = findCol("exemptions");
  const idxSourceUrl     = findCol("source url", "link");
  const idxNotes         = findCol("notes", "other requirements");

  if (idxStateName === -1) {
    console.warn("Could not find 'State / Jurisdiction' column in TSV");
    return;
  }

  // Optional: clear any previous rules
  STATES.forEach(s => { s.rules = []; });

  lines.slice(1).forEach(line => {
    const cols = line.split("\t");   // <-- tab here

    const stateName = (cols[idxStateName] || "").trim();
    if (!stateName) return;

    const state = STATES.find(
      s => s.name.toLowerCase() === stateName.toLowerCase()
    );
    if (!state) {
      console.warn("State in TSV not found in STATES list:", stateName);
      return;
    }

    const rule = {
      statute:             idxStatute       >= 0 ? (cols[idxStatute]       || "").trim() : "",
      pii:                 idxPII           >= 0 ? (cols[idxPII]           || "").trim() : "",
      breach:              idxBreach        >= 0 ? (cols[idxBreach]        || "").trim() : "",
      riskOfHarm:          idxRiskOfHarm    >= 0 ? (cols[idxRiskOfHarm]    || "").trim() : "",
      timingIndividuals:   idxTimingInd     >= 0 ? (cols[idxTimingInd]     || "").trim() : "",
      timingAG:            idxTimingAG      >= 0 ? (cols[idxTimingAG]      || "").trim() : "",
      timingCreditAgencies:idxTimingCredit  >= 0 ? (cols[idxTimingCredit]  || "").trim() : "",
      noticeContent:       idxNoticeContent >= 0 ? (cols[idxNoticeContent] || "").trim() : "",
      noticeMethod:        idxNoticeMethod  >= 0 ? (cols[idxNoticeMethod]  || "").trim() : "",
      penalties:           idxPenalties     >= 0 ? (cols[idxPenalties]     || "").trim() : "",
      exemptions:          idxExemptions    >= 0 ? (cols[idxExemptions]    || "").trim() : "",
      sourceUrl:           idxSourceUrl     >= 0 ? (cols[idxSourceUrl]     || "").trim() : "",
      notes:               idxNotes         >= 0 ? (cols[idxNotes]         || "").trim() : ""
    };

    if (!state.rules) state.rules = [];
    state.rules.push(rule);
  });

  if (activeStateCode) {
    setActiveState(activeStateCode);
  }
}

// Wire the <input type="file"> to the parser
const uploadModule = document.getElementById("uploadModule");

const csvFileInput = document.getElementById("csvFileInput");
if (csvFileInput) {
  csvFileInput.addEventListener("change", (e) => {
    const file = e.target.files && e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (evt) => {
      const text = evt.target.result;
      applySheetTsvText(text);

      // Hide upload after successful parse
      if (uploadModule) {
        uploadModule.classList.add("hidden");
      }
    };
    reader.readAsText(file);
  });
}


    // ---- Initial render --------------------------------------------------------
    renderStates();
    // loadSheetData(); // will do nothing until you set SHEET_CSV_URL
  </script>
</body>
</html>
